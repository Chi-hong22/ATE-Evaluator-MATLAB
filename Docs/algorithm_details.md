# 核心算法逻辑详解

本项目中的ATE（Absolute Trajectory Error）计算包含两个关键步骤：时间关联和空间对齐。本文件详细解释了这两个步骤的实现逻辑。

## 1. 时间关联 (Temporal Association)

### 1.1 目的
由于地面真实轨迹（Ground Truth）和估计轨迹（Estimated Trajectory）通常是在不同的时间点、以不同的频率记录的，直接对它们进行逐点比较是没有意义的。时间关联的目的是，**根据时间戳为两条轨迹建立起正确的对应关系**。

### 1.2 方法
我们采用**线性插值（Linear Interpolation）**的方法，将一条轨迹的数据点“映射”到另一条轨迹的时间戳上。具体流程如下：

1.  **确定基准时间戳**: 我们选择**地面真实轨迹**的时间戳作为插值的基准点。
2.  **寻找时间重叠区间**: 程序会自动找到两条轨迹时间戳的重叠范围 `[t_start, t_end]`。只有在这个区间内的真值轨迹点才会被用于后续计算。
3.  **执行插值**: 对于每一个在重叠区间内的真值时间戳 `t_gt`，我们使用MATLAB的 `interp1` 函数，在估计轨迹的时间序列中找到 `t_gt` 时刻对应的空间位置 `(x, y, z)`。
    -   `interp1` 会在估计轨迹中找到离 `t_gt` 最近的两个时间点，并在这两个点之间进行线性插值，计算出 `t_gt` 时刻的精确位置。
4.  **生成关联轨迹**: 插值完成后，我们会得到一条新的估计轨迹，它的数据点数和时间戳与重叠区间内的真值轨迹完全一致。这样，我们就拥有了两条可以直接进行逐点比较的轨迹。

## 2. 空间对齐 (Spatial Alignment)

### 2.1 目的
即使两条轨迹有了时间上的对应关系，它们通常仍然处于不同的坐标系中。直接计算它们的距离会引入一个巨大的系统性误差。空间对齐的目的是，**找到一个最优的刚体变换（旋转+平移），将估计轨迹对齐到真值轨迹的坐标系中**，从而消除坐标系不同带来的误差，只计算轨迹形状上的差异。

### 2.2 方法
我们使用经典的 **Horn方法（也称为绝对定向问题）**，通过奇异值分解（SVD）来求解最优的 `SE(3)` 变换矩阵。该方法能保证找到的变换使两条轨迹对应点之间的均方根误差（RMSE）最小化。

具体流程如下：

1.  **计算质心（Centroids）**:
    -   分别计算两条已关联轨迹（真值轨迹 `P_gt` 和插值后的估计轨迹 `P_est`）所有点的几何中心（即质心 `C_gt` 和 `C_est`）。
2.  **去中心化（Remove Centroids）**:
    -   将两条轨迹的所有点都减去各自的质心，得到两条新的、以原点为中心的点云 `P'_gt` 和 `P'_est`。这一步将平移部分从问题中分离出去，使我们能先专注于求解旋转。
3.  **计算协方差矩阵（Covariance Matrix）**:
    -   计算去中心化后的两条点云的协方差矩阵 `H`。`H` 是一个 `3x3` 矩阵，它描述了两条轨迹形状之间的关联性。
    
    $$
    H = \\sum_{i=1}^{N} (P'_{est,i}) (P'_{gt,i})^T
    $$

4.  **奇异值分解（SVD）**:
    -   对协方差矩阵 `H` 进行SVD分解：
    
    $$
    H = U \\Sigma V^T
    $$
    
    -   根据Horn方法的理论，最优的**旋转矩阵 `R`** 可以通过 `U` 和 `V` 计算得出：
    
    $$
    R = V U^T
    $$

5.  **处理反射情况（特殊情况）**:
    -   计算出的 `R` 可能是旋转矩阵，也可能是反射矩阵（一种会导致坐标系“翻转”的变换）。通过检查 `R` 的行列式 `det(R)` 可以判断：
        -   如果 `det(R) = +1`，`R` 是一个有效的旋转矩阵。
        -   如果 `det(R) = -1`，`R` 是一个反射矩阵。此时需要对 `V` 矩阵的最后一列取反，然后重新计算 `R`，以确保得到一个纯粹的旋转。
6.  **计算平移向量（Translation Vector）**:
    -   在求得最优旋转 `R` 之后，利用第一步中计算的质心，可以很容易地计算出**平移向量 `t`**：
    
    $$
    t = C_{gt} - R \\cdot C_{est}
    $$

7.  **应用变换**:
    -   最后，将计算出的旋转矩阵 `R` 和平移向量 `t` 应用于**原始的、插值后的**估计轨迹 `P_est`，得到最终对齐的轨迹 `P_aligned_est`：
    
    $$
    P_{aligned\\_est} = R \\cdot P_{est} + t
    $$

经过这两个步骤，我们得到的 `P_{aligned\\_est}` 就是与真值轨迹在时间和空间上都对齐的轨迹。此时再计算它们之间的欧几里得距离，就能得到准确的绝对轨迹误差（ATE）。
