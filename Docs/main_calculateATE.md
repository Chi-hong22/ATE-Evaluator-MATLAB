
# `main_calculateATE.m` 模块文档

## 1. 模块概述

`main_calculateATE.m` 是用于绝对轨迹误差 (Absolute Trajectory Error, ATE) 分析的核心脚本。该脚本负责加载地面真实轨迹 (Ground Truth) 和一个或多个估计轨迹 (Estimated Trajectories)，对它们进行时间戳对齐和空间对齐，计算ATE，并生成一系列可视化图表和数据文件。

该脚本可以同时处理两种估计轨迹：
- **Corrupted Trajectory**: 通常指未经优化的、原始的或带有噪声的轨迹。
- **Optimized Trajectory**: 通常指经过某种算法（如SLAM后端优化）处理后的轨迹。

脚本会自动检测输入文件夹中是否存在这两种轨迹文件，并对存在的文件进行完整的ATE分析。

## 2. 功能特性

- **灵活的配置管理**: 通过 `config.m` 文件集中管理所有参数，如文件路径、图表样式、保存选项等。
- **自动文件检测**: 自动检测并加载地面真值和估计轨迹文件。
- **完整的ATE计算**:
  - 时间戳关联：将估计轨迹与地面真值轨迹进行时间戳对齐。
  - SE(3) 对齐：使用Umeyama算法对齐估计轨迹和地面真值轨迹。
  - 误差计算：计算对齐后每对匹配点的欧氏距离作为误差。
  - 统计指标：计算ATE的均方根误差 (RMSE)、均值、中位数、标准差、最大值和最小值。
- **多角度可视化**:
  - **原始轨迹对比图**: 在同一坐标系中绘制未经对齐的地面真值和所有估计轨迹。
  - **对齐后轨迹对比图**: 分别绘制每条估计轨迹与对齐后的地面真值轨迹。
  - **ATE时间序列图**: 绘制误差随时间变化的曲线。
  - **ATE直方图**: 展示误差的分布情况。
  - **ATE累积分布函数 (CDF) 图**: 显示误差小于某一特定值的概率。
- **数据与图像保存**:
  - 可选择将计算出的ATE指标、对齐后的轨迹数据等保存为 `.mat` 或 `.csv` 文件。
  - 可选择将所有生成的图表保存为高分辨率的图像文件 (如 `.png`)。
- **格式化输出**: 在命令行中清晰地输出每一步的处理信息和最终的ATE统计总结。

## 3. 核心逻辑流程

脚本的执行流程如下：

1.  **配置与初始化**:
    - `clear; close all; clc;` 清理工作区。
    - 将 `Src` 目录添加到MATLAB路径中。
    - 调用 `config()` 函数加载所有配置参数。
    - 根据配置文件构建输入文件的完整路径，并检查文件是否存在。
    - 创建一个带时间戳的结果输出目录。

2.  **加载地面真值轨迹**:
    - 调用 `readTrajectory()` 函数从指定路径加载地面真值轨迹数据（时间戳和位姿）。

3.  **处理估计轨迹**:
    - 遍历 `corrupted` 和 `optimized` 两种轨迹。
    - 如果轨迹文件存在，则执行以下操作：
      - 调用 `readTrajectory()` 加载估计轨迹。
      - 调用 `alignAndComputeATE()` 函数，该函数内部完成时间戳关联、SE(3)对齐和ATE计算，返回ATE统计指标和对齐后的轨迹数据。
      - 将计算结果（指标、对齐轨迹等）存储在 `trajectory_results` 结构体数组中。
      - 打印当前轨迹的ATE RMSE值。

4.  **可视化**:
    - **绘制原始轨迹图**: 调用 `plotTrajectories()` 函数绘制所有未经对齐的原始轨迹。
    - **遍历处理结果**: 对每一种估计轨迹（`corrupted`/`optimized`），生成以下图表：
      - **对齐轨迹图**: 调用 `plotTrajectories()` 绘制对齐后的估计轨迹与地面真值。
      - **ATE分析图**: 调用 `plotATEData()` 函数，该函数内部会生成时间序列图、直方图和CDF图。
    - 所有生成的图窗句柄都会被收集起来，以便后续统一处理。

5.  **保存数据**:
    - 如果 `cfg.SAVE_DATA` 设置为 `true`：
    - 遍历每一种轨迹的分析结果。
    - 调用 `saveTrajectoryData()` 函数，将ATE指标和详细的轨迹数据保存到文件中。

6.  **应用图像格式**:
    - 遍历所有生成的图窗。
    - 根据 `config.m` 中的配置，统一设置所有图表的字体大小、尺寸和位置，确保输出风格一致。

7.  **保存图像**:
    - 如果 `cfg.SAVE_FIGURES` 设置为 `true`：
    - 遍历所有图窗，并根据预设的文件名（如 `trajectory_comparison_optimized.png`）将它们保存为 `.png` 文件到结果目录。

8.  **输出总结**:
    - 在MATLAB命令行中，以清晰的格式打印出每种轨迹的ATE统计摘要，包括RMSE、Mean、Median、Std等。

## 4. 如何使用

1.  **配置 `config.m`**:
    - 打开 `Src/config.m` 文件。
    - 设置 `INPUT_FOLDER` 指向包含轨迹数据的文件夹。
    - 确保 `GT_FILE_NAME`, `EST_CORRUPTED_FILE_NAME`, `EST_OPTIMIZED_FILE_NAME` 与您的文件名匹配。
    - 根据需要调整 `SAVE_FIGURES`, `SAVE_DATA` 等保存选项以及图表样式参数。
2.  **运行脚本**:
    - 在MATLAB中打开 `main_calculateATE.m` 文件。
    - 点击 "运行" 按钮或在命令行中输入 `main` 并回车。
3.  **查看结果**:
    - 脚本运行过程中，MATLAB会实时显示生成的图表。
    - 运行结束后，检查命令行输出的ATE总结。
    - 如果启用了保存选项，请到 `Results` 目录下对应时间戳的文件夹中查看保存的图像和数据文件。

